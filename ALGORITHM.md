# Алгоритм работы системы автоматизированного сканирования портов

## Описание задачи

Система предназначена для автоматизированного сканирования открытых портов на целевых IP-адресах с использованием Masscan и Nmap. Результаты сканирования отслеживаются и сравниваются с историей. Об изменениях отправляются уведомления в Telegram.

## Общая архитектура

Система состоит из следующих основных компонентов:

1. MasscanScanner - быстрое сканирование портов
2. BannerGrabber - определение сервисов на открытых портах
3. ScanHistory - ведение истории сканирований и обнаружение изменений
4. TelegramNotifier - отправка уведомлений в мессенджер
5. PortScannerOrchestrator - координация всех компонентов
6. Config - загрузка и управление конфигурацией

## Основные режимы работы

### Режим 1: Разовое сканирование (Одноразовое выполнение)

Используется когда в конфиге установлено schedule.enabled = false

Процесс работы:
1. Загружается конфигурация
2. Отправляется уведомление о начале сканирования в Telegram
3. Для каждой целевой IP-адреса или сети:
   - Запускается Masscan для поиска открытых портов
   - Для каждого найденного порта запускается Nmap для определения сервиса
4. Собираются все результаты
5. Отправляется одно общее сообщение с полным списком открытых портов и сервисов
6. Программа завершается

### Режим 2: Периодическое сканирование (По расписанию)

Используется когда в конфиге установлено schedule.enabled = true

Процесс работы:
1. Загружается конфигурация
2. Отправляется одно начальное уведомление о запуске периодического сканирования
3. Запускается цикл с указанным интервалом:
   3.1. На каждой итерации выполняется полное сканирование всех целей
   3.2. Результаты сравниваются с историей:
      - Если найдены новые открытые порты - отправляется уведомление
      - Если сервис на порту изменился - отправляется уведомление
      - Если изменений нет - никаких уведомлений не отправляется
   3.3. История обновляется
   3.4. Ожидание до следующего цикла сканирования
4. При нажатии Ctrl+C:
   - Отправляется финальное уведомление с общей статистикой
   - Программа завершается

## Пошаговый алгоритм сканирования одной цели

Шаг 1: Получение конфигурации цели
- Считывается название, IP-адрес или диапазон, список портов

Шаг 2: Запуск Masscan
- Формируется команда: masscan 
- Выполняется процесс сканирования
- Результаты сохраняются во временный JSON-файл

Шаг 3: Парсинг результатов Masscan
- Читается временный JSON-файл построчно
- Для каждой строки распарсивается информация о найденном порту
- Накапливается список открытых портов

Шаг 4: Определение сервисов (Banner Grabbing)
- Для каждого открытого порта запускается Nmap в режиме определения сервиса
- Nmap выполняет попытку соединения и определяет название и версию сервиса
- Результат (название и версия сервиса) сохраняется

Шаг 5: Сравнение с историей
- Загружается предыдущая история сканирования
- Определяются новые порты (которых не было ранее)
- Определяются измененные сервисы (сервис на том же порту изменился)

Шаг 6: Действие в зависимости от режима

Для режима разового сканирования:
- Отправляется одно сообщение с полным списком открытых портов и сервисов

Для режима периодического сканирования:
- Если найдены новые порты: отправляется сообщение о новых портах
- Если найдены измененные сервисы: отправляется сообщение об изменениях
- Если ничего не изменилось: никаких сообщений не отправляется

Шаг 7: Обновление истории
- Новая информация о портах и сервисах сохраняется в файл истории scan_history.json

## Остановка программы

Когда пользователь нажимает Ctrl+C:

- Отправляется финальное уведомление с общей статистикой (количество циклов, проверок)
- Программа корректно завершается, освобождая все ресурсы

## Структура данных истории сканирования

История хранится в файле scan_history.json в следующем формате:

``` json
{
  "1.1.1.1": {
    "first_scanned": "2026-01-29 20:13:44",
    "ports": [
        80,
        443,
        8080],
    "services": {
      "80": "http Cloudflare http proxy",
      "443": "http Cloudflare http proxy",
      "8080": "http Cloudflare http proxy"
    },
    "last_scanned": "2026-01-29 20:14:48"
  }
}
```

IP-адрес служит ключом. Для каждого IP хранится:
- first_scanned: дата первого сканирования
- last_scanned: дата последнего сканирования
- ports: список всех открытых портов
- services: словарь соответствия номера порта и названия сервиса

## Внешние зависимости

1. Masscan - утилита для быстрого сканирования портов
2. Nmap - утилита для детального сканирования и определения сервисов
3. python-telegram-bot - библиотека для работы с Telegram API
4. python-nmap - Python-обертка для Nmap

## Конфигурирование системы

Система настраивается через файл app/config.json:

- scan_target: список целей с указанием имени, IP/диапазона, портов (Список объектов)
- masscan_config: параметры Masscan (скорость, таймаут)
- telegram: учетные данные бота (загружаются из .env)
- schedule: параметры расписания (включена ли автоматизация, интервал)

## Заключение

Система реализует две основные схемы работы:
- Разовое сканирование для быстрого получения информации о портах
- Периодическое сканирование с умными уведомлениями об изменениях

Все операции асинхронные для предотвращения блокировок. Система корректно обрабатывает прерывания и гарантирует отправку финальных уведомлений.
